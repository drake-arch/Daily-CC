<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Daily Inventory</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #101314;
      color: #EDEFED;
      overflow-x: hidden;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .gradient-bg {
      background: linear-gradient(-45deg, #0D2D53, #1a4d7a, #0D2D53, #164a6e);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }

    .floating {
      animation: float 6s ease-in-out infinite;
    }

    .fade-in-up {
      animation: fadeInUp 0.8s ease-out forwards;
    }

    .scale-in {
      animation: scaleIn 0.5s ease-out forwards;
    }

    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glow {
      box-shadow: 0 0 30px rgba(163, 243, 197, 0.3);
    }

    .input-focus:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(163, 243, 197, 0.3);
      border-color: #A3F3C5;
    }

    .grid-bg {
      background-image: 
        linear-gradient(rgba(163, 243, 197, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(163, 243, 197, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .home-btn {
      position: fixed;
      top: 1.5rem;
      left: 1.5rem;
      z-index: 50;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      color: #A3F3C5;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
    }

    .home-btn:hover {
      background: #1e2223;
    }

    .btn {
      padding: 1.25rem 3rem;
      border-radius: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      width: 100%;
      max-width: 28rem;
      margin: 0 auto;
    }

    .btn-primary {
      background: #A3F3C5;
      color: #101314;
    }

    .btn-primary:hover:not(:disabled) {
      background: #8de0ad;
      transform: scale(1.05);
    }

    .btn-secondary {
      background: #2a2d2e;
      color: #EDEFED;
      border: 1px solid #3a3d3e;
    }

    .btn-secondary:hover {
      background: #3a3d3e;
      border-color: #A3F3C5;
    }

    .btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2.5rem;
      max-width: 56rem;
      width: 100%;
    }

    .title {
      font-size: 3.75rem;
      font-weight: 300;
      text-align: center;
      background: linear-gradient(to right, white, #A3F3C5);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    .subtitle {
      text-align: center;
      color: #9D9F9E;
      font-size: 1.125rem;
      margin-bottom: 3rem;
    }

    .input {
      width: 100%;
      padding: 1rem 1.5rem;
      background: #1a1d1e;
      border: 2px solid #2a2d2e;
      border-radius: 0.75rem;
      color: #EDEFED;
      font-size: 1.125rem;
      transition: all 0.3s;
    }

    .input:focus {
      outline: none;
      border-color: #A3F3C5;
      box-shadow: 0 0 0 3px rgba(163, 243, 197, 0.3);
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1.5rem;
      border-left: 4px solid;
    }

    .alert-success {
      background: rgba(6, 78, 59, 0.2);
      border-color: #10b981;
      color: #34d399;
    }

    .alert-error {
      background: rgba(127, 29, 29, 0.2);
      border-color: #ef4444;
      color: #f87171;
    }

    .alert-warning {
      background: rgba(120, 53, 15, 0.2);
      border-color: #eab308;
      color: #facc15;
    }

    .progress-bar {
      background: #2a2d2e;
      height: 0.75rem;
      border-radius: 100px;
      overflow: hidden;
      margin: 2rem 0 1rem;
    }

    .progress-fill {
      background: linear-gradient(90deg, #0D2D53, #1a4d7a, #A3F3C5);
      height: 100%;
      transition: width 0.5s;
    }

    .location-card {
      background: linear-gradient(135deg, #0D2D53, #1a4d7a);
      border-radius: 1rem;
      padding: 3rem 2rem;
      text-align: center;
      position: relative;
      margin-bottom: 2rem;
    }

    .location-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #0D2D53, #A3F3C5, #0D2D53);
    }

    .location-label {
      font-size: 0.875rem;
      color: #A3F3C5;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .location-value {
      font-size: 4rem;
      color: white;
      font-weight: 700;
      font-family: 'Courier New', monospace;
      margin-bottom: 1.5rem;
      letter-spacing: 0.1em;
    }

    .hidden {
      display: none !important;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .flex-col {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .orb {
      position: absolute;
      background: #A3F3C5;
      opacity: 0.1;
      border-radius: 50%;
      filter: blur(60px);
    }

    .orb-1 {
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      animation: float 6s ease-in-out infinite;
    }

    .orb-2 {
      bottom: 5rem;
      right: 2.5rem;
      width: 24rem;
      height: 24rem;
      animation: float 6s ease-in-out infinite;
      animation-delay: -3s;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    // Suppress XLSX console warnings about compression
    const originalConsoleError = console.error;
    console.error = function(...args) {
      const message = args.join(' ');
      if (message.includes('uncompressed size') || message.includes('Bad uncompressed')) {
        // Suppress these specific warnings
        return;
      }
      originalConsoleError.apply(console, args);
    };

    const SHEETS_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';

    let state = {
      stage: 'home',
      slottingData: null,
      cycleCountData: null,
      locationVerificationData: null,
      employeeName: '',
      currentIndex: 0,
      mode: null,
      attemptNumber: 0,
      firstCountValue: null,
      verificationStep: 'location', // 'location', 'sku', or 'quantity'
      skuAttempts: 0,
      wrongSku: null
    };

    function parseCSV(file, type) {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          if (type === 'slotting') {
            validateSlottingData(results.data);
          } else if (type === 'cycle') {
            validateCycleCountData(results.data);
          }
        },
        error: (error) => {
          showAlert(`Error parsing file: ${error.message}`, 'error');
        }
      });
    }

    function parseExcel(file, type) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          // Use cellDates and cellNF options, and ignore compression errors
          const workbook = XLSX.read(data, { 
            type: 'array',
            cellDates: true,
            cellNF: false,
            WTF: false // Suppress warnings
          });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
            raw: false,
            defval: ''
          });
          
          if (type === 'verification') {
            validateLocationVerificationData(jsonData);
          }
        } catch (error) {
          console.error('Excel parsing error:', error);
          showAlert(`Error parsing Excel file: ${error.message}`, 'error');
        }
      };
      reader.onerror = () => {
        showAlert('Error reading file', 'error');
      };
      reader.readAsArrayBuffer(file);
    }

    function validateSlottingData(data) {
      const requiredHeaders = ['sku', 'from_location', 'to_location'];
      if (data.length === 0) {
        showAlert('File is empty', 'error');
        return;
      }

      const headers = Object.keys(data[0]).map(h => h.toLowerCase().trim());
      const missing = requiredHeaders.filter(h => !headers.includes(h));
      
      if (missing.length > 0) {
        showAlert(`Missing required headers: ${missing.join(', ')}`, 'error');
        return;
      }

      const normalized = data.map(row => ({
        sku: row.sku || row.SKU || '',
        from_location: row.from_location || row.From_Location || row.FROM_LOCATION || '',
        to_location: row.to_location || row.To_Location || row.TO_LOCATION || ''
      })).filter(row => row.from_location && row.to_location);

      if (normalized.length === 0) {
        showAlert('No valid slotting records found', 'error');
        return;
      }

      state.slottingData = normalized;
      showAlert(`‚úÖ Slotting file loaded: ${normalized.length} moves`, 'success');
      render();
    }

    function validateCycleCountData(data) {
      const requiredHeaders = ['location', 'on_hand'];
      if (data.length === 0) {
        showAlert('File is empty', 'error');
        return;
      }

      const headers = Object.keys(data[0]).map(h => h.toLowerCase().trim().replace(/ /g, '_'));
      const missing = requiredHeaders.filter(h => !headers.includes(h));
      
      if (missing.length > 0) {
        showAlert(`Missing required headers: ${missing.join(', ')}`, 'error');
        return;
      }

      const normalized = data.map(row => {
        const location = row.location || row.Location || row.LOCATION || '';
        const onHand = row.on_hand || row.On_Hand || row['Location On Hand'] || row.ON_HAND || 0;
        
        return {
          location: location.trim(),
          on_hand: parseInt(onHand) || 0
        };
      }).filter(row => row.location);

      if (normalized.length === 0) {
        showAlert('No valid cycle count records found', 'error');
        return;
      }

      state.cycleCountData = normalized;
      showAlert(`‚úÖ Cycle count file loaded: ${normalized.length} locations`, 'success');
      render();
    }

    function validateLocationVerificationData(data) {
      const requiredHeaders = ['location', 'sku', 'location on hand'];
      if (data.length === 0) {
        showAlert('File is empty', 'error');
        return;
      }

      const headers = Object.keys(data[0]).map(h => h.toLowerCase().trim());
      const hasRequired = requiredHeaders.every(h => 
        headers.some(header => header.includes(h.replace(' on hand', '')) || header === h)
      );
      
      if (!hasRequired) {
        showAlert(`Missing required columns: Location, SKU, Location On Hand`, 'error');
        return;
      }

      const normalized = data.map(row => {
        const location = row.Location || row.location || row.LOCATION || '';
        const sku = row.SKU || row.sku || '';
        const onHand = row['Location On Hand'] || row['location on hand'] || row.on_hand || 0;
        
        return {
          location: String(location).trim().toUpperCase(),
          sku: String(sku).trim().toUpperCase(),
          on_hand: parseInt(onHand) || 0
        };
      }).filter(row => row.location && row.sku);

      if (normalized.length === 0) {
        showAlert('No valid location verification records found', 'error');
        return;
      }

      state.locationVerificationData = normalized;
      showAlert(`‚úÖ Location verification file loaded: ${normalized.length} locations`, 'success');
      render();
    }

    async function logToSheets(eventData) {
      const payload = {
        timestamp: new Date().toISOString(),
        employee_name: state.employeeName,
        mode: state.mode,
        ...eventData
      };

      try {
        await fetch(SHEETS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        console.log('Logged to sheets:', payload);
      } catch (error) {
        console.error('Failed to log to sheets:', error);
      }
    }

    function startSlotting() {
      if (!state.slottingData) {
        alert('No slotting file loaded');
        return;
      }
      state.mode = 'slotting';
      state.currentIndex = 0;
      state.stage = 'slotting';
      render();
    }

    function completeSlottingStep() {
      const current = state.slottingData[state.currentIndex];
      
      logToSheets({
        sku: current.sku,
        from_location: current.from_location,
        to_location: current.to_location,
        status: 'completed',
        step_index: state.currentIndex + 1,
        step_total: state.slottingData.length
      });

      if (state.currentIndex < state.slottingData.length - 1) {
        state.currentIndex++;
        render();
      } else {
        state.stage = 'complete';
        render();
      }
    }

    function skipSlottingStep() {
      const current = state.slottingData[state.currentIndex];
      
      logToSheets({
        sku: current.sku,
        from_location: current.from_location,
        to_location: current.to_location,
        status: 'skipped',
        step_index: state.currentIndex + 1,
        step_total: state.slottingData.length
      });

      if (state.currentIndex < state.slottingData.length - 1) {
        state.currentIndex++;
        render();
      } else {
        state.stage = 'complete';
        render();
      }
    }

    function startCycleCount() {
      if (!state.cycleCountData) {
        alert('No cycle count file loaded');
        return;
      }
      state.mode = 'cycle_count';
      state.currentIndex = 0;
      state.attemptNumber = 0;
      state.firstCountValue = null;
      state.stage = 'cycle_count';
      render();
    }

    function verifyCycleLocation() {
      const scannedLocation = document.getElementById('locationInput').value.trim().toUpperCase();
      const current = state.cycleCountData[state.currentIndex];

      if (!scannedLocation) {
        showCycleAlert('‚ö†Ô∏è Please scan or enter a location', 'error');
        return;
      }

      if (scannedLocation !== current.location.toUpperCase()) {
        showCycleAlert(`‚ùå Wrong location! Expected: ${current.location}`, 'error');
        document.getElementById('locationInput').value = '';
        document.getElementById('locationInput').focus();
        return;
      }

      showCycleAlert('‚úÖ Location verified! Now enter count', 'success');
      document.getElementById('locationInput').disabled = true;
      document.getElementById('countInput').disabled = false;
      document.getElementById('countInput').focus();
      document.getElementById('verifyBtn').classList.add('hidden');
      document.getElementById('submitBtn').classList.remove('hidden');
    }

    function submitCycleCount() {
      const count = parseInt(document.getElementById('countInput').value);
      const current = state.cycleCountData[state.currentIndex];

      if (isNaN(count) || count < 0) {
        showCycleAlert('‚ö†Ô∏è Please enter a valid count', 'error');
        return;
      }

      if (state.attemptNumber === 0) {
        state.attemptNumber = 1;
        state.firstCountValue = count;

        if (count === current.on_hand) {
          logToSheets({
            location: current.location,
            expected_on_hand: current.on_hand,
            entered_count: count,
            status: 'match',
            attempt: 1,
            step_index: state.currentIndex + 1,
            step_total: state.cycleCountData.length
          });

          showCycleAlert('‚úÖ Perfect! Count matches', 'success');
          setTimeout(() => moveToNextLocation(), 1000);
        } else {
          logToSheets({
            location: current.location,
            expected_on_hand: current.on_hand,
            entered_count: count,
            status: 'mismatch_first_attempt',
            attempt: 1,
            step_index: state.currentIndex + 1,
            step_total: state.cycleCountData.length
          });

          showCycleAlert('‚ö†Ô∏è Not quite right ‚Äî give it another go', 'warning');
          document.getElementById('countInput').value = '';
          document.getElementById('countInput').focus();
          document.getElementById('countLabel').textContent = 'üîÑ Second Count (Required)';
        }
      } else {
        logToSheets({
          location: current.location,
          expected_on_hand: current.on_hand,
          entered_count: count,
          status: 'accepted_second_attempt',
          attempt: 2,
          step_index: state.currentIndex + 1,
          step_total: state.cycleCountData.length
        });

        if (count === current.on_hand) {
          showCycleAlert('‚úÖ Second count matches!', 'success');
        } else {
          showCycleAlert(`‚úì Accepted. Variance: ${count - current.on_hand}`, 'success');
        }
        
        setTimeout(() => moveToNextLocation(), 1200);
      }
    }

    function skipCycleCount() {
      const current = state.cycleCountData[state.currentIndex];
      
      logToSheets({
        location: current.location,
        expected_on_hand: current.on_hand,
        entered_count: null,
        status: 'skipped',
        attempt: 0,
        step_index: state.currentIndex + 1,
        step_total: state.cycleCountData.length
      });

      moveToNextLocation();
    }

    function moveToNextLocation() {
      if (state.currentIndex < state.cycleCountData.length - 1) {
        state.currentIndex++;
        state.attemptNumber = 0;
        state.firstCountValue = null;
        render();
      } else {
        state.stage = 'complete';
        render();
      }
    }

    // Location Verification Functions
    function startLocationVerification() {
      if (!state.locationVerificationData) {
        alert('No location verification file loaded');
        return;
      }
      state.mode = 'location_verification';
      state.currentIndex = 0;
      state.verificationStep = 'location';
      state.skuAttempts = 0;
      state.wrongSku = null;
      state.stage = 'location_verification';
      render();
    }

    function verifyLocation() {
      const scannedLocation = document.getElementById('locationVerifyInput').value.trim().toUpperCase();
      const current = state.locationVerificationData[state.currentIndex];

      if (!scannedLocation) {
        showVerificationAlert('‚ö†Ô∏è Please scan or enter a location', 'error');
        return;
      }

      if (scannedLocation !== current.location) {
        showVerificationAlert(`‚ùå Wrong location! Expected: ${current.location}`, 'error');
        document.getElementById('locationVerifyInput').value = '';
        document.getElementById('locationVerifyInput').focus();
        
        logToSheets({
          location: current.location,
          expected_sku: current.sku,
          scanned_location: scannedLocation,
          status: 'wrong_location',
          step_index: state.currentIndex + 1,
          step_total: state.locationVerificationData.length
        });
        return;
      }

      showVerificationAlert('‚úÖ Location verified! Now scan SKU', 'success');
      state.verificationStep = 'sku';
      
      logToSheets({
        location: current.location,
        expected_sku: current.sku,
        scanned_location: scannedLocation,
        status: 'location_verified',
        step_index: state.currentIndex + 1,
        step_total: state.locationVerificationData.length
      });
      
      setTimeout(() => render(), 800);
    }

    function verifySku() {
      const scannedSku = document.getElementById('skuVerifyInput').value.trim().toUpperCase();
      const current = state.locationVerificationData[state.currentIndex];

      if (!scannedSku) {
        showVerificationAlert('‚ö†Ô∏è Please scan or enter a SKU', 'error');
        return;
      }

      if (scannedSku !== current.sku) {
        state.skuAttempts++;
        
        if (state.skuAttempts === 1) {
          state.wrongSku = scannedSku;
          showVerificationAlert(`‚ùå Wrong SKU! Try again. Expected: ${current.sku}`, 'error');
          document.getElementById('skuVerifyInput').value = '';
          document.getElementById('skuVerifyInput').focus();
          
          logToSheets({
            location: current.location,
            expected_sku: current.sku,
            scanned_sku: scannedSku,
            status: 'wrong_sku_attempt_1',
            step_index: state.currentIndex + 1,
            step_total: state.locationVerificationData.length
          });
          return;
        } else if (state.skuAttempts === 2 && scannedSku === state.wrongSku) {
          // Same wrong SKU twice, ask for quantity
          showVerificationAlert('‚ö†Ô∏è Same SKU scanned twice. Please enter quantity', 'warning');
          state.verificationStep = 'quantity';
          
          logToSheets({
            location: current.location,
            expected_sku: current.sku,
            scanned_sku: scannedSku,
            status: 'wrong_sku_attempt_2_same',
            step_index: state.currentIndex + 1,
            step_total: state.locationVerificationData.length
          });
          
          setTimeout(() => render(), 800);
          return;
        } else {
          // Different wrong SKU on second attempt
          showVerificationAlert(`‚ùå Still wrong! Expected: ${current.sku}`, 'error');
          document.getElementById('skuVerifyInput').value = '';
          document.getElementById('skuVerifyInput').focus();
          
          logToSheets({
            location: current.location,
            expected_sku: current.sku,
            scanned_sku: scannedSku,
            status: 'wrong_sku_attempt_2_different',
            step_index: state.currentIndex + 1,
            step_total: state.locationVerificationData.length
          });
          return;
        }
      }

      // Correct SKU
      showVerificationAlert('‚úÖ SKU verified! Moving to next location', 'success');
      
      logToSheets({
        location: current.location,
        expected_sku: current.sku,
        scanned_sku: scannedSku,
        status: 'sku_verified_correct',
        step_index: state.currentIndex + 1,
        step_total: state.locationVerificationData.length
      });
      
      setTimeout(() => moveToNextVerification(), 1000);
    }

    function submitQuantity() {
      const quantity = parseInt(document.getElementById('quantityInput').value);
      const current = state.locationVerificationData[state.currentIndex];

      if (isNaN(quantity) || quantity < 0) {
        showVerificationAlert('‚ö†Ô∏è Please enter a valid quantity', 'error');
        return;
      }

      showVerificationAlert(`‚úì Quantity recorded: ${quantity}. Moving to next location`, 'success');
      
      logToSheets({
        location: current.location,
        expected_sku: current.sku,
        scanned_sku: state.wrongSku,
        entered_quantity: quantity,
        expected_quantity: current.on_hand,
        status: 'wrong_sku_quantity_entered',
        step_index: state.currentIndex + 1,
        step_total: state.locationVerificationData.length
      });
      
      setTimeout(() => moveToNextVerification(), 1200);
    }

    function skipVerification() {
      const current = state.locationVerificationData[state.currentIndex];
      
      logToSheets({
        location: current.location,
        expected_sku: current.sku,
        status: 'skipped',
        step_index: state.currentIndex + 1,
        step_total: state.locationVerificationData.length
      });

      moveToNextVerification();
    }

    function moveToNextVerification() {
      if (state.currentIndex < state.locationVerificationData.length - 1) {
        state.currentIndex++;
        state.verificationStep = 'location';
        state.skuAttempts = 0;
        state.wrongSku = null;
        render();
      } else {
        state.stage = 'complete';
        render();
      }
    }

    function showAlert(message, type) {
      const alertDiv = document.getElementById('globalAlert');
      if (!alertDiv) return;
      
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => { alertDiv.innerHTML = ''; }, 5000);
    }

    function showCycleAlert(message, type) {
      const alertDiv = document.getElementById('cycleAlert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    function showVerificationAlert(message, type) {
      const alertDiv = document.getElementById('verificationAlert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    function goHome() {
      if (confirm('Go back to home? Progress will be lost.')) {
        state = {
          stage: 'home',
          slottingData: state.slottingData,
          cycleCountData: state.cycleCountData,
          locationVerificationData: state.locationVerificationData,
          employeeName: '',
          currentIndex: 0,
          mode: null,
          attemptNumber: 0,
          firstCountValue: null,
          verificationStep: 'location',
          skuAttempts: 0,
          wrongSku: null
        };
        render();
      }
    }

    function setupFileUpload(inputId, type) {
      const input = document.getElementById(inputId);
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          if (type === 'verification') {
            parseExcel(file, type);
          } else {
            parseCSV(file, type);
          }
        }
      });
    }

    function render() {
      const app = document.getElementById('app');
      let content = '';

      if (state.stage === 'home') {
        const filesReady = state.slottingData || state.cycleCountData || state.locationVerificationData;
        content = `
          <div class="gradient-bg grid-bg" style="min-height: 100vh; position: relative;">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            
            <div class="container">
              <div style="max-width: 80rem; width: 100%; text-align: center;" class="fade-in-up">
                <div style="display: inline-block; padding: 0.5rem 1.5rem; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 9999px; color: #A3F3C5; font-size: 1.125rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 2rem; box-shadow: 0 0 30px rgba(163, 243, 197, 0.3);">
                  Operations Reporting Platform
                </div>
                
                <h1 style="font-size: 6rem; font-weight: 100; line-height: 1.1; margin-bottom: 2rem; background: linear-gradient(to right, white, #A3F3C5); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                  Daily<br/>Inventory
                </h1>
                
                <p style="font-size: 1.5rem; color: #9D9F9E; max-width: 48rem; margin: 0 auto 3rem; font-weight: 300; line-height: 1.6;">
                  "Inventory is our customers' livelihood, we are their bank"
                </p>
                
                <div class="flex-col" style="max-width: 28rem; margin: 0 auto;">
                  <button onclick="state.stage = 'manager'; render();" class="btn btn-secondary">
                    üì§ Upload Data
                  </button>
                  
                  <button onclick="state.stage = 'employee'; render();" ${!filesReady ? 'disabled' : ''} class="btn btn-primary glow">
                    üìä Start Your Count
                  </button>

                  <button onclick="alert('Capture Data feature coming soon!');" class="btn btn-secondary">
                    üì∏ Capture Data
                  </button>
                </div>
                
                ${!filesReady ? '<p style="color: #9D9F9E; font-size: 0.875rem; margin-top: 1.5rem;">Please upload files via Upload Data first</p>' : ''}
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'manager') {
        content = `
          <button onclick="state.stage = 'home'; render();" class="home-btn">
            üè† Home
          </button>
          
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in" style="max-width: 56rem;">
              <h2 class="title" style="font-size: 3.75rem;">Upload Data</h2>
              <p class="subtitle">Upload daily files</p>

              <div id="globalAlert"></div>

              <div style="margin-bottom: 2rem; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 2rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                  <h3 style="font-size: 1.5rem; font-weight: 300; color: #A3F3C5;">Slotting File</h3>
                  <span style="padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; ${state.slottingData ? 'background: rgba(6, 78, 59, 0.2); color: #34d399;' : 'background: rgba(127, 29, 29, 0.2); color: #f87171;'}">
                    ${state.slottingData ? '‚úì Loaded' : '‚úó Not Loaded'}
                  </span>
                </div>
                <p style="color: #9D9F9E; font-size: 0.875rem; margin-bottom: 1.5rem;">Required: sku, from_location, to_location</p>
                <input type="file" id="slottingFile" accept=".csv,.tsv" style="display: none;">
                <button onclick="document.getElementById('slottingFile').click()" class="btn btn-secondary">
                  üìÅ Upload Slotting File (CSV)
                </button>
                ${state.slottingData ? `<p style="text-align: center; color: #A3F3C5; font-size: 0.875rem; margin-top: 1rem;">${state.slottingData.length} moves loaded</p>` : ''}
              </div>

              <div style="margin-bottom: 2rem; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 2rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                  <h3 style="font-size: 1.5rem; font-weight: 300; color: #A3F3C5;">Cycle Count File</h3>
                  <span style="padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; ${state.cycleCountData ? 'background: rgba(6, 78, 59, 0.2); color: #34d399;' : 'background: rgba(127, 29, 29, 0.2); color: #f87171;'}">
                    ${state.cycleCountData ? '‚úì Loaded' : '‚úó Not Loaded'}
                  </span>
                </div>
                <p style="color: #9D9F9E; font-size: 0.875rem; margin-bottom: 1.5rem;">Required: location, on_hand</p>
                <input type="file" id="cycleFile" accept=".csv,.tsv" style="display: none;">
                <button onclick="document.getElementById('cycleFile').click()" class="btn btn-secondary">
                  üìÅ Upload Cycle Count File (CSV)
                </button>
                ${state.cycleCountData ? `<p style="text-align: center; color: #A3F3C5; font-size: 0.875rem; margin-top: 1rem;">${state.cycleCountData.length} locations loaded</p>` : ''}
              </div>

              <div style="background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 2rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                  <h3 style="font-size: 1.5rem; font-weight: 300; color: #A3F3C5;">Location Verification File</h3>
                  <span style="padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; ${state.locationVerificationData ? 'background: rgba(6, 78, 59, 0.2); color: #34d399;' : 'background: rgba(127, 29, 29, 0.2); color: #f87171;'}">
                    ${state.locationVerificationData ? '‚úì Loaded' : '‚úó Not Loaded'}
                  </span>
                </div>
                <p style="color: #9D9F9E; font-size: 0.875rem; margin-bottom: 1.5rem;">Required: Location, SKU, Location On Hand (Excel file)</p>
                <input type="file" id="verificationFile" accept=".xlsx,.xls" style="display: none;">
                <button onclick="document.getElementById('verificationFile').click()" class="btn btn-secondary">
                  üìÅ Upload Location Verification File (Excel)
                </button>
                ${state.locationVerificationData ? `<p style="text-align: center; color: #A3F3C5; font-size: 0.875rem; margin-top: 1rem;">${state.locationVerificationData.length} locations loaded</p>` : ''}
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'employee') {
        content = `
          <button onclick="state.stage = 'home'; render();" class="home-btn">
            üè† Home
          </button>
          
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in" style="max-width: 56rem;">
              <h2 class="title" style="font-size: 3.75rem;">Get After It</h2>
              <p class="subtitle">Select your workflow</p>

              <div style="margin-bottom: 2rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">Employee Name / ID</label>
                <input type="text" id="employeeName" class="input" placeholder="Enter your name or ID" autofocus>
              </div>

              <div class="grid-3">
                <button onclick="if(document.getElementById('employeeName').value.trim()) { state.employeeName = document.getElementById('employeeName').value.trim(); startCycleCount(); } else { alert('Please enter your name or ID'); }" ${!state.cycleCountData ? 'disabled' : ''} class="glass" style="border-radius: 1rem; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                  <span style="font-size: 1.5rem; font-weight: 300; display: block; margin-bottom: 0.5rem;">Cycle Count</span>
                  <div style="color: #9D9F9E; font-size: 0.875rem;">${state.cycleCountData ? `${state.cycleCountData.length} locations` : 'No file loaded'}</div>
                </button>

                <button onclick="if(document.getElementById('employeeName').value.trim()) { state.employeeName = document.getElementById('employeeName').value.trim(); startSlotting(); } else { alert('Please enter your name or ID'); }" ${!state.slottingData ? 'disabled' : ''} class="glass" style="border-radius: 1rem; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                  <span style="font-size: 1.5rem; font-weight: 300; display: block; margin-bottom: 0.5rem;">Slotting</span>
                  <div style="color: #9D9F9E; font-size: 0.875rem;">${state.slottingData ? `${state.slottingData.length} moves` : 'No file loaded'}</div>
                </button>

                <button onclick="if(document.getElementById('employeeName').value.trim()) { state.employeeName = document.getElementById('employeeName').value.trim(); startLocationVerification(); } else { alert('Please enter your name or ID'); }" ${!state.locationVerificationData ? 'disabled' : ''} class="glass" style="border-radius: 1rem; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
                  <span style="font-size: 1.5rem; font-weight: 300; display: block; margin-bottom: 0.5rem;">Location Verification</span>
                  <div style="color: #9D9F9E; font-size: 0.875rem;">${state.locationVerificationData ? `${state.locationVerificationData.length} locations` : 'No file loaded'}</div>
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'slotting') {
        const current = state.slottingData[state.currentIndex];
        const progress = ((state.currentIndex / state.slottingData.length) * 100).toFixed(0);
        
        content = `
          <button onclick="goHome()" class="home-btn">
            üè† Home
          </button>
          
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in">
              <div style="text-align: right; margin-bottom: 1.5rem; color: #A3F3C5; font-weight: 600;">
                Slotting: ${state.employeeName}
              </div>

              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                Step ${state.currentIndex + 1} of ${state.slottingData.length}
              </div>

              <div class="location-card">
                <div style="margin-bottom: 2rem;">
                  <div class="location-label">Go to:</div>
                  <div class="location-value">${current.from_location}</div>
                </div>

                <div style="font-size: 2rem; color: white; margin-bottom: 2rem;">‚Üì</div>

                <div>
                  <div class="location-label">Move all contents to:</div>
                  <div class="location-value">${current.to_location}</div>
                </div>

                ${current.sku ? `<div style="margin-top: 1.5rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 0.75rem; display: inline-block; color: #EDEFED;">SKU: ${current.sku}</div>` : ''}
              </div>

              <div class="grid-2">
                <button onclick="completeSlottingStep()" class="btn btn-primary glow">
                  ‚úì Mark Completed & Next
                </button>
                <button onclick="skipSlottingStep()" class="btn btn-secondary">
                  Skip
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'cycle_count') {
        const current = state.cycleCountData[state.currentIndex];
        const progress = ((state.currentIndex / state.cycleCountData.length) * 100).toFixed(0);
        
        content = `
          <button onclick="goHome()" class="home-btn">
            üè† Home
          </button>
          
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in">
              <div style="text-align: right; margin-bottom: 1.5rem; color: #A3F3C5; font-weight: 600;">
                Cycle Count: ${state.employeeName}
              </div>

              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progress}%"></div>
              </div>
              <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                Location ${state.currentIndex + 1} of ${state.cycleCountData.length}
              </div>

              <div class="location-card">
                <div class="location-label">Start Here</div>
                <div class="location-value">${current.location}</div>
                <div style="margin-top: 1rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 0.75rem; display: inline-block; color: #EDEFED;">
                  <strong>Expected On Hand:</strong> ${current.on_hand}
                </div>
              </div>

              <div id="cycleAlert"></div>

              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                  üîç Scan/Enter Location
                </label>
                <input type="text" id="locationInput" class="input" placeholder="Scan location" style="font-size: 1.5rem; font-family: 'Courier New', monospace; text-align: center;" autofocus>
              </div>

              <div style="margin-bottom: 1.5rem;">
                <label id="countLabel" style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                  üì¶ Enter Count
                </label>
                <input type="number" id="countInput" class="input" placeholder="0" min="0" style="font-size: 1.5rem; font-family: 'Courier New', monospace; text-align: center;" disabled>
              </div>

              <div class="grid-2">
                <button id="verifyBtn" onclick="verifyCycleLocation()" class="btn btn-primary glow">
                  ‚úì Verify Location
                </button>
                <button id="submitBtn" onclick="submitCycleCount()" class="btn btn-primary glow hidden">
                  ‚úì Submit Count
                </button>
                <button onclick="skipCycleCount()" class="btn btn-secondary">
                  Skip
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.stage === 'location_verification') {
        const current = state.locationVerificationData[state.currentIndex];
        const progress = ((state.currentIndex / state.locationVerificationData.length) * 100).toFixed(0);
        
        if (state.verificationStep === 'location') {
          content = `
            <button onclick="goHome()" class="home-btn">
              üè† Home
            </button>
            
            <div class="gradient-bg grid-bg container">
              <div class="card scale-in">
                <div style="text-align: right; margin-bottom: 1.5rem; color: #A3F3C5; font-weight: 600;">
                  Location Verification: ${state.employeeName}
                </div>

                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                  Location ${state.currentIndex + 1} of ${state.locationVerificationData.length}
                </div>

                <div class="location-card">
                  <div class="location-label">Go to Location</div>
                  <div class="location-value">${current.location}</div>
                  <div style="margin-top: 1rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 0.75rem; display: inline-block; color: #EDEFED;">
                    Expected On Hand: ${current.on_hand}
                  </div>
                </div>

                <div id="verificationAlert"></div>

                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üîç Scan Location
                  </label>
                  <input type="text" id="locationVerifyInput" class="input" placeholder="Scan location barcode" style="font-size: 1.5rem; font-family: 'Courier New', monospace; text-align: center;" autofocus>
                </div>

                <div class="grid-2">
                  <button onclick="verifyLocation()" class="btn btn-primary glow">
                    ‚úì Verify Location
                  </button>
                  <button onclick="skipVerification()" class="btn btn-secondary">
                    Skip
                  </button>
                </div>
              </div>
            </div>
          `;
        } else if (state.verificationStep === 'sku') {
          content = `
            <button onclick="goHome()" class="home-btn">
              üè† Home
            </button>
            
            <div class="gradient-bg grid-bg container">
              <div class="card scale-in">
                <div style="text-align: right; margin-bottom: 1.5rem; color: #A3F3C5; font-weight: 600;">
                  Location Verification: ${state.employeeName}
                </div>

                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                  Location ${state.currentIndex + 1} of ${state.locationVerificationData.length}
                </div>

                <div class="location-card">
                  <div class="location-label">Verify SKU at</div>
                  <div class="location-value">${current.location}</div>
                  <div style="margin-top: 1rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 0.75rem; display: inline-block; color: #EDEFED;">
                    Expected SKU: ${current.sku}
                  </div>
                </div>

                <div id="verificationAlert"></div>

                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üì¶ Scan SKU ${state.skuAttempts > 0 ? '(Attempt ' + (state.skuAttempts + 1) + ')' : ''}
                  </label>
                  <input type="text" id="skuVerifyInput" class="input" placeholder="Scan SKU barcode" style="font-size: 1.5rem; font-family: 'Courier New', monospace; text-align: center;" autofocus>
                </div>

                <div class="grid-2">
                  <button onclick="verifySku()" class="btn btn-primary glow">
                    ‚úì Verify SKU
                  </button>
                  <button onclick="skipVerification()" class="btn btn-secondary">
                    Skip
                  </button>
                </div>
              </div>
            </div>
          `;
        } else if (state.verificationStep === 'quantity') {
          content = `
            <button onclick="goHome()" class="home-btn">
              üè† Home
            </button>
            
            <div class="gradient-bg grid-bg container">
              <div class="card scale-in">
                <div style="text-align: right; margin-bottom: 1.5rem; color: #A3F3C5; font-weight: 600;">
                  Location Verification: ${state.employeeName}
                </div>

                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="text-align: center; color: #9D9F9E; font-size: 0.875rem; font-weight: 600; margin-top: 0.75rem;">
                  Location ${state.currentIndex + 1} of ${state.locationVerificationData.length}
                </div>

                <div class="location-card">
                  <div class="location-label">Enter Quantity at</div>
                  <div class="location-value">${current.location}</div>
                  <div style="margin-top: 1rem; padding: 1rem 1.5rem; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 0.75rem; display: inline-block; color: #EDEFED;">
                    Scanned SKU: ${state.wrongSku}<br>
                    Expected SKU: ${current.sku}
                  </div>
                </div>

                <div id="verificationAlert"></div>

                <div style="margin-bottom: 1.5rem;">
                  <label style="display: block; font-size: 0.875rem; font-weight: 600; color: #9D9F9E; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;">
                    üìä Enter Quantity of ${state.wrongSku}
                  </label>
                  <input type="number" id="quantityInput" class="input" placeholder="0" min="0" style="font-size: 1.5rem; font-family: 'Courier New', monospace; text-align: center;" autofocus>
                </div>

                <div class="grid-2">
                  <button onclick="submitQuantity()" class="btn btn-primary glow">
                    ‚úì Submit Quantity
                  </button>
                  <button onclick="skipVerification()" class="btn btn-secondary">
                    Skip
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      } else if (state.stage === 'complete') {
        content = `
          <div class="gradient-bg grid-bg container">
            <div class="card scale-in" style="text-align: center; padding: 4rem;">
              <div style="font-size: 5rem; margin-bottom: 2rem;">üéâ</div>
              <h2 style="font-size: 3.75rem; font-weight: 300; margin-bottom: 1.5rem; background: linear-gradient(to right, white, #A3F3C5); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                ${state.mode === 'slotting' ? 'Slotting' : state.mode === 'cycle_count' ? 'Cycle Count' : 'Location Verification'} Complete!
              </h2>
              <p style="color: #9D9F9E; font-size: 1.25rem; margin-bottom: 3rem; font-weight: 300;">
                Great work, ${state.employeeName}! All tasks have been completed and logged.
              </p>
              
              <button onclick="state.stage = 'home'; state.currentIndex = 0; state.mode = null; state.employeeName = ''; state.attemptNumber = 0; state.firstCountValue = null; state.verificationStep = 'location'; state.skuAttempts = 0; state.wrongSku = null; render();" class="btn btn-primary glow">
                Back to Home
              </button>
            </div>
          </div>
        `;
      }

      app.innerHTML = content;

      if (state.stage === 'manager') {
        setTimeout(() => {
          setupFileUpload('slottingFile', 'slotting');
          setupFileUpload('cycleFile', 'cycle');
          setupFileUpload('verificationFile', 'verification');
        }, 100);
      }

      if (state.stage === 'cycle_count') {
        setTimeout(() => {
          document.getElementById('locationInput').focus();
          document.getElementById('locationInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyCycleLocation();
          });
          document.getElementById('countInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitCycleCount();
          });
        }, 100);
      }

      if (state.stage === 'location_verification') {
        setTimeout(() => {
          if (state.verificationStep === 'location') {
            const input = document.getElementById('locationVerifyInput');
            if (input) {
              input.focus();
              input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyLocation();
              });
            }
          } else if (state.verificationStep === 'sku') {
            const input = document.getElementById('skuVerifyInput');
            if (input) {
              input.focus();
              input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifySku();
              });
            }
          } else if (state.verificationStep === 'quantity') {
            const input = document.getElementById('quantityInput');
            if (input) {
              input.focus();
              input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitQuantity();
              });
            }
          }
        }, 100);
      }

      if (state.stage === 'employee') {
        setTimeout(() => {
          document.getElementById('employeeName').focus();
        }, 100);
      }
    }

    render();
  </script>
</body>
</html>
